# Minimal OpenAI Codex CLI Docker Image
FROM node:20-alpine

# Add edge community repo for ttyd
RUN echo "http://dl-cdn.alpinelinux.org/alpine/edge/community" >> /etc/apk/repositories && \
    apk add --no-cache \
    ttyd \
    bash \
    git \
    python3 \
    py3-pip \
    && rm -rf /var/cache/apk/*

# Install OpenAI Codex CLI globally
RUN npm install -g @openai/codex --production --no-audit --no-fund && \
    npm cache clean --force && \
    rm -rf /tmp/* /root/.npm

# Create config directory
RUN mkdir -p /root/.codex

# Create startup script that launches OpenAI Codex automatically
RUN echo '#!/bin/bash' > /start.sh && \
    echo 'if [ -z "$OPENAI_API_KEY" ]; then' >> /start.sh && \
    echo '  echo "Error: Set OPENAI_API_KEY environment variable"' >> /start.sh && \
    echo '  echo "Get API key: https://platform.openai.com/api-keys"' >> /start.sh && \
    echo '  exit 1' >> /start.sh && \
    echo 'fi' >> /start.sh && \
    echo '' >> /start.sh && \
    echo 'echo "Starting OpenAI Codex CLI..."' >> /start.sh && \
    echo 'exec codex' >> /start.sh && \
    chmod +x /start.sh

# Set proper environment for interactive terminal
ENV TERM=xterm-256color
ENV SHELL=/bin/bash

EXPOSE 7681
WORKDIR /workspace

# Start ttyd with OpenAI Codex CLI automatically
CMD ["ttyd", "-W", "-p", "7681", "-t", "titleFixed=OpenAI Codex CLI", "/bin/bash", "/start.sh"]
