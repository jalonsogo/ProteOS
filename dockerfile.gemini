# Minimal Gemini CLI Docker Image
FROM node:20-alpine

# Add edge community repo for ttyd
RUN echo "http://dl-cdn.alpinelinux.org/alpine/edge/community" >> /etc/apk/repositories && \
    apk add --no-cache \
    ttyd \
    bash \
    git \
    && rm -rf /var/cache/apk/*

# Install Gemini CLI globally
RUN npm install -g @google/gemini-cli --production --no-audit --no-fund && \
    npm cache clean --force && \
    rm -rf /tmp/* /root/.npm

# Create startup script
RUN echo '#!/bin/bash' > /start.sh && \
    echo 'if [ -z "$GEMINI_API_KEY" ]; then' >> /start.sh && \
    echo '  echo "Error: Set GEMINI_API_KEY environment variable"' >> /start.sh && \
    echo '  echo "Get your API key from: https://aistudio.google.com/apikey"' >> /start.sh && \
    echo '  echo "Exiting..."' >> /start.sh && \
    echo '  sleep 5' >> /start.sh && \
    echo '  exit 1' >> /start.sh && \
    echo 'fi' >> /start.sh && \
    echo '' >> /start.sh && \
    echo 'echo "Gemini CLI ready at http://localhost:7681"' >> /start.sh && \
    echo 'echo ""' >> /start.sh && \
    echo 'echo "Available commands:"' >> /start.sh && \
    echo 'echo "  gemini           - Start interactive chat"' >> /start.sh && \
    echo 'echo "  gemini --help    - Show help"' >> /start.sh && \
    echo 'echo "  gemini chat      - Start chat mode"' >> /start.sh && \
    echo 'echo ""' >> /start.sh && \
    chmod +x /start.sh

# Set proper environment for interactive terminal
ENV TERM=xterm-256color
ENV SHELL=/bin/bash

EXPOSE 7681
WORKDIR /workspace

# Use ttyd with proper options for interactive terminal
CMD ["ttyd", "-W", "-p", "7681", "-t", "titleFixed=Gemini CLI Terminal", "-t", "theme={'background':'#1e1e1e','foreground':'#ffffff'}", "/bin/bash", "-il", "-c", "source /start.sh; exec bash -i"]
